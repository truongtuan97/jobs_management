name: Auto Deploy to EC2

on:
  push:
    branches:
      - main  # Hoáº·c branch báº¡n muá»‘n deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Chá»‰ táº£i commit má»›i nháº¥t
        
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e  # Dá»«ng script náº¿u cÃ³ lá»—i

          export COMPOSE_HTTP_TIMEOUT=300
          cd /home/ubuntu/app  # ÄÆ°á»ng dáº«n Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n trÃªn EC2
          git pull origin main  # Láº¥y code má»›i nháº¥t

          # Táº¡o thÆ° má»¥c data náº¿u chÆ°a cÃ³ (Ä‘á»ƒ trÃ¡nh lá»—i permission)
          if [ ! -d "/home/ubuntu/app/postgres_data" ]; then
            mkdir -p /home/ubuntu/app/postgres_data
            sudo chown -R ubuntu:ubuntu /home/ubuntu/app/postgres_data
          fi

          echo "ðŸ”¹ Stopping & removing old containers..."
          docker-compose down --remove-orphans

          # echo "ðŸ”¹ Removing all Docker images..."
          # docker rmi -f $(docker images -aq) || true

          # echo "ðŸ”¹ Pruning Docker system..."
          # docker system prune -af --volumes || true

          echo "ðŸ”¹ Rebuilding & deploying services..."
          docker-compose -f docker-compose.prod.yml up --build -d
        EOF
